<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rankine Cycle 系统可视化 (简化版)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 基础样式 */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { overflow: hidden; height: 100vh; }
        
        /* 三栏布局 */
        .app { display: flex; height: 100%; }
        .sidebar { width: 120px; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .main { flex: 1; display: flex; flex-direction: column; background: #f0f0f0; }
        .properties { width: 240px; background: #fff; box-shadow: -0 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        /* 设备列表样式 */
        .device-list { padding: 10px; overflow-y: auto; flex: 1; }
        .device-item { 
            padding: 8px; margin: 5px; border: 1px solid #eee; 
            border-radius: 4px; cursor: pointer; text-align: center;
            background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .device-item:hover { background: #e6f7ff; border-color: #91d5ff; }
        .device-icon { font-size: 18px; margin-bottom: 5px; }
        .device-name { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* 画布样式 */
        .canvas-container { flex: 1; position: relative; background: #f8f9fa; overflow: auto; }
        #canvas { 
            position: absolute; top: 0; left: 0; 
            background-image: linear-gradient(#eee 1px, transparent 1px),
                              linear-gradient(90deg, #eee 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .device { 
            position: absolute; background: #e3f2fd; border: 1px solid #90caf9; 
            border-radius: 4px; padding: 10px; text-align: center; cursor: move;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 10;
        }
        .device.selected { outline: 2px dashed #2196f3; outline-offset: 2px; }
        .port { 
            position: absolute; width: 12px; height: 12px; border-radius: 50%; 
            background: #03a9f4; cursor: crosshair; z-index: 20;
        }
        .port:hover { transform: scale(1.2); box-shadow: 0 0 0 2px white, 0 0 0 4px #03a9f4; }
        .connection { 
            position: absolute; background: #03a9f4; height: 2px; z-index: 5;
            transform-origin: 0 0;
        }
        .connection-arrow { 
            position: absolute; width: 0; height: 0; 
            border-left: 6px solid #03a9f4; border-top: 3px solid transparent; 
            border-bottom: 3px solid transparent; transform-origin: center; z-index: 6;
        }
        
        /* 操作栏样式 */
        .toolbar { padding: 10px; background: #fff; border-bottom: 1px solid #eee; }
        .toolbar button { 
            padding: 6px 10px; margin-right: 5px; border: none; 
            border-radius: 4px; cursor: pointer; font-size: 12px;
        }
        .toolbar button:hover { background: #e0e0e0; }
        .toolbar .save { background: #4caf50; color: white; }
        .toolbar .load { background: #2196f3; color: white; }
        .toolbar .clear { background: #f44336; color: white; }
        
        /* 属性面板样式 */
        .properties-header { padding: 10px; border-bottom: 1px solid #eee; }
        .properties-content { padding: 10px; overflow-y: auto; flex: 1; }
        .property-group { margin-bottom: 15px; }
        .property-title { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .property-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #eee; }
        .property-name { color: #666; font-size: 12px; }
        .property-value { font-weight: bold; font-size: 12px; }
        .notification {
            position: fixed; top: 20px; right: 20px;
            padding: 8px 15px; background: #4caf50; color: white;
            border-radius: 4px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transform: translateX(calc(100% + 20px)); transition: transform 0.3s ease;
        }
        .notification.show { transform: translateX(0); }
    </style>
</head>
<body>
    <div class="app">
        <!-- 左侧设备列表 -->
        <div class="sidebar">
            <div class="device-list" id="device-list">
                <div class="device-item" data-type="turbine">
                    <div class="device-icon"><i class="fas fa-tachometer-alt"></i></div>
                    <div class="device-name">汽轮机</div>
                </div>
                <div class="device-item" data-type="boiler">
                    <div class="device-icon"><i class="fas fa-fire"></i></div>
                    <div class="device-name">锅炉</div>
                </div>
                <div class="device-item" data-type="condenser">
                    <div class="device-icon"><i class="fas fa-snowflake"></i></div>
                    <div class="device-name">冷凝器</div>
                </div>
                <div class="device-item" data-type="pump">
                    <div class="device-icon"><i class="fas fa-pump"></i></div>
                    <div class="device-name">泵</div>
                </div>
            </div>
        </div>
        
        <!-- 中间画布区域 -->
        <div class="main">
            <div class="toolbar">
                <button class="save" id="save-btn"><i class="fas fa-save"></i> 保存</button>
                <button class="load" id="load-btn"><i class="fas fa-load"></i> 加载</button>
                <button class="clear" id="clear-btn"><i class="fas fa-trash"></i> 清空</button>
            </div>
            <div class="canvas-container" id="canvas-container">
                <div id="canvas"></div>
            </div>
        </div>
        
        <!-- 右侧属性面板 -->
        <div class="properties">
            <div class="properties-header">
                <h3>设备属性</h3>
            </div>
            <div class="properties-content" id="properties-panel">
                <p style="text-align: center; padding: 20px; color: #999;">请选择一个设备</p>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // 设备管理器
        class DeviceManager {
            constructor(canvas) {
                this.canvas = canvas;
                this.devices = [];
                this.nextId = 1;
            }
            
            addDevice(type, x, y) {
                const device = this.createDevice(type, x, y);
                this.devices.push(device);
                this.canvas.appendChild(device.element);
                return device;
            }
            
            createDevice(type, x, y) {
                const id = `device-${this.nextId++}`;
                let element, ports = [];
                
                // 根据类型创建设备
                if (type === 'turbine') {
                    element = document.createElement('div');
                    element.className = 'device';
                    element.style.width = '80px';
                    element.style.height = '60px';
                    element.innerHTML = '<div style="font-size: 12px; font-weight: bold;">汽轮机</div>';
                    
                    // 创建端口
                    ports = [
                        { type: 'in', x: 80, y: 30 },
                        { type: 'out', x: 0, y: 30 }
                    ];
                } else if (type === 'boiler') {
                    element = document.createElement('div');
                    element.className = 'device';
                    element.style.width = '60px';
                    element.style.height = '80px';
                    element.innerHTML = '<div style="font-size: 12px; font-weight: bold;">锅炉</div>';
                    
                    ports = [
                        { type: 'in', x: 30, y: 0 },
                        { type: 'out', x: 30, y: 80 }
                    ];
                } else if (type === 'condenser') {
                    element = document.createElement('div');
                    element.className = 'device';
                    element.style.width = '60px';
                    element.style.height = '80px';
                    element.innerHTML = '<div style="font-size: 12px; font-weight: bold;">冷凝器</div>';
                    
                    ports = [
                        { type: 'in', x: 30, y: 80 },
                        { type: 'out', x: 30, y: 0 }
                    ];
                } else if (type === 'pump') {
                    element = document.createElement('div');
                    element.className = 'device';
                    element.style.width = '50px';
                    element.style.height = '50px';
                    element.innerHTML = '<div style="font-size: 12px; font-weight: bold;">泵</div>';
                    
                    ports = [
                        { type: 'in', x: 0, y: 25 },
                        { type: 'out', x: 50, y: 25 }
                    ];
                }
                
                // 设置设备位置
                element.style.left = `${x}px`;
                element.style.top = `${y}px`;
                
                // 创建端口
                const devicePorts = [];
                ports.forEach(port => {
                    const portElement = document.createElement('div');
                    portElement.className = 'port';
                    portElement.style.left = `${port.x}px`;
                    portElement.style.top = `${port.y}px`;
                    element.appendChild(portElement);
                    
                    devicePorts.push({
                        type: port.type,
                        element: portElement,
                        x: port.x,
                        y: port.y
                    });
                });
                
                return {
                    id,
                    type,
                    x,
                    y,
                    element,
                    ports: devicePorts,
                    selected: false,
                    setSelected: (selected) => {
                        this.selected = selected;
                        if (selected) {
                            element.classList.add('selected');
                        } else {
                            element.classList.remove('selected');
                        }
                    }
                };
            }
            
            selectDevice(id) {
                this.devices.forEach(device => device.setSelected(false));
                const device = this.devices.find(d => d.id === id);
                if (device) device.setSelected(true);
                return device;
            }
            
            getDevice(id) {
                return this.devices.find(d => d.id === id);
            }
            
            removeDevice(id) {
                const index = this.devices.findIndex(d => d.id === id);
                if (index === -1) return;
                
                const device = this.devices[index];
                this.canvas.removeChild(device.element);
                this.devices.splice(index, 1);
            }
            
            clearAll() {
                this.devices.forEach(device => this.canvas.removeChild(device.element));
                this.devices = [];
                this.nextId = 1;
            }
        }
        
        // 连接管理器
        class ConnectionManager {
            constructor(canvas) {
                this.canvas = canvas;
                this.connections = [];
                this.nextId = 1;
            }
            
            createConnection(fromDevice, fromPort, toDevice, toPort) {
                const connection = this.createConnectionElement(fromDevice, fromPort, toDevice, toPort);
                this.connections.push(connection);
                this.canvas.appendChild(connection.element);
                this.canvas.appendChild(connection.arrow);
                return connection;
            }
            
            createConnectionElement(fromDevice, fromPort, toDevice, toPort) {
                const id = `connection-${this.nextId++}`;
                const element = document.createElement('div');
                element.className = 'connection';
                const arrow = document.createElement('div');
                arrow.className = 'connection-arrow';
                
                this.updateConnectionPosition(element, arrow, fromDevice, fromPort, toDevice, toPort);
                
                return {
                    id,
                    fromDevice,
                    fromPort,
                    toDevice,
                    toPort,
                    element,
                    arrow,
                    update: () => this.updateConnectionPosition(element, arrow, fromDevice, fromPort, toDevice, toPort)
                };
            }
            
            updateConnectionPosition(element, arrow, fromDevice, fromPort, toDevice, toPort) {
                const fromRect = fromDevice.element.getBoundingClientRect();
                const toRect = toDevice.element.getBoundingClientRect();
                const canvasRect = this.canvas.getBoundingClientRect();
                
                const fromX = fromPort.x + fromRect.left - canvasRect.left;
                const fromY = fromPort.y + fromRect.top - canvasRect.top;
                const toX = toPort.x + toRect.left - canvasRect.left;
                const toY = toPort.y + toRect.top - canvasRect.top;
                
                const dx = toX - fromX;
                const dy = toY - fromY;
                const length = Math.sqrt(dx * dx + dy * dy);
                const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                
                element.style.width = `${length}px`;
                element.style.left = `${fromX}px`;
                element.style.top = `${fromY}px`;
                element.style.transform = `rotate(${angle}deg)`;
                
                const arrowX = toX - 6 * Math.cos(angle * Math.PI / 180);
                const arrowY = toY - 6 * Math.sin(angle * Math.PI / 180);
                
                arrow.style.left = `${arrowX}px`;
                arrow.style.top = `${arrowY}px`;
                arrow.style.transform = `rotate(${angle}deg)`;
            }
            
            removeConnection(id) {
                const connection = this.connections.find(c => c.id === id);
                if (connection) {
                    this.canvas.removeChild(connection.element);
                    this.canvas.removeChild(connection.arrow);
                    this.connections = this.connections.filter(c => c.id !== id);
                }
            }
            
            removeConnectionsForDevice(device) {
                this.connections.forEach(connection => {
                    if (connection.fromDevice === device || connection.toDevice === device) {
                        this.canvas.removeChild(connection.element);
                        this.canvas.removeChild(connection.arrow);
                    }
                });
                this.connections = this.connections.filter(connection => 
                    connection.fromDevice !== device && connection.toDevice !== device
                );
            }
            
            clearAll() {
                this.connections.forEach(connection => {
                    this.canvas.removeChild(connection.element);
                    this.canvas.removeChild(connection.arrow);
                });
                this.connections = [];
            }
        }
        
        // 主应用
        class RankineCycleApp {
            constructor() {
                this.canvas = document.getElementById('canvas');
                this.canvasContainer = document.getElementById('canvas-container');
                this.deviceList = document.getElementById('device-list');
                this.propertiesPanel = document.getElementById('properties-panel');
                this.notification = document.getElementById('notification');
                
                // 初始化管理器
                this.deviceManager = new DeviceManager(this.canvas);
                this.connectionManager = new ConnectionManager(this.canvas);
                
                // 初始化事件
                this.initEvents();
                
                // 调整画布大小
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
            }
            
            initEvents() {
                // 设备列表点击事件
                this.deviceList.querySelectorAll('.device-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        this.selectedDeviceType = item.dataset.type;
                        this.canvasContainer.style.cursor = 'crosshair';
                        this.showNotification(`点击画布添加 ${item.querySelector('.device-name').textContent}`);
                    });
                });
                
                // 画布点击事件
                this.canvas.addEventListener('click', (e) => {
                    if (this.selectedDeviceType) {
                        const rect = this.canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        this.addDevice(this.selectedDeviceType, x, y);
                        this.selectedDeviceType = null;
                        this.canvasContainer.style.cursor = 'default';
                    }
                });
                
                // 清空按钮
                document.getElementById('clear-btn').addEventListener('click', () => {
                    if (confirm('确定要清空画布吗？')) {
                        this.deviceManager.clearAll();
                        this.connectionManager.clearAll();
                        this.propertiesPanel.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">请选择一个设备</p>';
                        this.showNotification('画布已清空');
                    }
                });
                
                // 保存/加载功能（简化版）
                document.getElementById('save-btn').addEventListener('click', () => this.saveProject());
                document.getElementById('load-btn').addEventListener('click', () => this.loadProject());
            }
            
            addDevice(type, x, y) {
                const device = this.deviceManager.addDevice(type, x, y);
                
                // 添加拖拽功能
                this.setupDrag(device);
                
                // 更新属性面板
                this.deviceManager.selectDevice(device.id);
                this.updatePropertiesPanel(device);
                
                // 显示通知
                this.showNotification(`已添加 ${type === 'turbine' ? '汽轮机' : type === 'boiler' ? '锅炉' : type === 'condenser' ? '冷凝器' : '泵'}`);
            }
            
            setupDrag(device) {
                let isDragging = false;
                let offsetX, offsetY;
                
                device.element.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('port')) return;
                    
                    isDragging = true;
                    offsetX = e.clientX - device.x;
                    offsetY = e.clientY - device.y;
                    device.element.style.zIndex = 100;
                    e.stopPropagation();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    
                    const x = e.clientX - offsetX;
                    const y = e.clientY - offsetY;
                    
                    device.x = x;
                    device.y = y;
                    device.element.style.left = `${x}px`;
                    device.element.style.top = `${y}px`;
                    
                    // 更新连接
                    this.connectionManager.connections.forEach(connection => {
                        if (connection.fromDevice === device || connection.toDevice === device) {
                            connection.update();
                        }
                    });
                });
                
                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        device.element.style.zIndex = 10;
                    }
                });
                
                // 端口点击事件
                device.ports.forEach(port => {
                    port.element.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.handlePortClick(device, port);
                    });
                });
            }
            
            handlePortClick(device, port) {
                if (this.selectedPort) {
                    if (this.selectedPort.device !== device) {
                        this.connectionManager.createConnection(
                            this.selectedPort.device, this.selectedPort.port,
                            device, port
                        );
                    }
                    this.selectedPort.device.ports.forEach(p => p.element.classList.remove('port-selected'));
                    this.selectedPort = null;
                } else {
                    this.selectedPort = { device, port };
                    port.element.classList.add('port-selected');
                }
            }
            
            updatePropertiesPanel(device) {
                if (!device) {
                    this.propertiesPanel.innerHTML = '<p style="text-align: center; padding: 20px; color: #999;">请选择一个设备</p>';
                    return;
                }
                
                let properties = '';
                if (device.type === 'turbine') {
                    properties = `
                        <div class="property-group">
                            <div class="property-title">设备参数</div>
                            <div class="property-item">
                                <div class="property-name">入口压力</div>
                                <div class="property-value">8.0 MPa</div>
                            </div>
                            <div class="property-item">
                                <div class="property-name">出口压力</div>
                                <div class="property-value">0.1 MPa</div>
                            </div>
                            <div class="property-item">
                                <div class="property-name">效率</div>
                                <div class="property-value">85%</div>
                            </div>
                        </div>
                    `;
                } else if (device.type === 'boiler') {
                    properties = `
                        <div class="property-group">
                            <div class="property-title">设备参数</div>
                            <div class="property-item">
                                <div class="property-name">入口压力</div>
                                <div class="property-value">6.0 MPa</div>
                            </div>
                            <div class="property-item">
                                <div class="property-name">出口压力</div>
                                <div class="property-value">8.0 MPa</div>
                            </div>
                            <div class="property-item">
                                <div class="property-name">温度</div>
                                <div class="property-value">500°C</div>
                            </div>
                        </div>
                    `;
                } else if (device.type === 'condenser') {
                    properties = `
                        <div class="property-group">
                            <div class="property-title">设备参数</div>
                            <div class="property-item">
                                <div class="property-name">入口压力</div>
                                <div class="property-value">0.1 MPa</div>
                            </div>
                            <div class="property-item">
                                <div class="property-name">出口压力</div>
                                <div class="property-value">0.08 MPa</div>
                            </div>
                            <div class="property-item">
                                <div class="property-name">温度</div>
                                <div class="property-value">40°C</div>
                            </div>
                        </div>
                    `;
                } else if (device.type === 'pump') {
                    properties = `
                        <div class="property-group">
                            <div class="property-title">设备参数</div>
                            <div class="property-item">
                                <div class="property-name">入口压力</div>
                                <div class="property-value">0.08 MPa</div>
                            </div>
                            <div class="property-item">
                                <div class="property-name">出口压力</div>
                                <div class="property-value">6.0 MPa</div>
                            </div>
                            <div class="property-item">
                                <div class="property-name">效率</div>
                                <div class="property-value">75%</div>
                            </div>
                        </div>
                    `;
                }
                
                this.propertiesPanel.innerHTML = `
                    <div class="property-group">
                        <div class="property-title">基本信息</div>
                        <div class="property-item">
                            <div class="property-name">ID</div>
                            <div class="property-value">${device.id}</div>
                        </div>
                        <div class="property-item">
                            <div class="property-name">类型</div>
                            <div class="property-value">${device.type === 'turbine' ? '汽轮机' : device.type === 'boiler' ? '锅炉' : device.type === 'condenser' ? '冷凝器' : '泵'}</div>
                        </div>
                        <div class="property-item">
                            <div class="property-name">位置</div>
                            <div class="property-value">(${Math.round(device.x)}, ${Math.round(device.y)})</div>
                        </div>
                    </div>
                    ${properties}
                `;
            }
            
            resizeCanvas() {
                const rect = this.canvasContainer.getBoundingClientRect();
                this.canvas.style.width = `${rect.width}px`;
                this.canvas.style.height = `${rect.height}px`;
            }
            
            saveProject() {
                const project = {
                    devices: this.deviceManager.devices.map(device => ({
                        id: device.id,
                        type: device.type,
                        x: device.x,
                        y: device.y
                    })),
                    connections: this.connectionManager.connections.map(connection => ({
                        from: connection.fromDevice.id,
                        fromPort: connection.fromPort.type,
                        to: connection.toDevice.id,
                        toPort: connection.toPort.type
                    }))
                };
                
                const json = JSON.stringify(project, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rankine-cycle-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showNotification('项目已保存');
            }
            
            loadProject() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const project = JSON.parse(event.target.result);
                            this.deviceManager.clearAll();
                            this.connectionManager.clearAll();
                            
                            // 恢复设备
                            project.devices.forEach(deviceData => {
                                this.deviceManager.addDevice(deviceData.type, deviceData.x, deviceData.y);
                            });
                            
                            // 恢复连接（简化版，需要设备已存在）
                            project.connections.forEach(connectionData => {
                                const fromDevice = this.deviceManager.getDevice(connectionData.from);
                                const toDevice = this.deviceManager.getDevice(connectionData.to);
                                
                                if (fromDevice && toDevice) {
                                    const fromPort = fromDevice.ports.find(p => p.type === connectionData.fromPort);
                                    const toPort = toDevice.ports.find(p => p.type === connectionData.toPort);
                                    
                                    if (fromPort && toPort) {
                                        this.connectionManager.createConnection(fromDevice, fromPort, toDevice, toPort);
                                    }
                                }
                            });
                            
                            this.showNotification('项目加载成功');
                        } catch (error) {
                            this.showNotification('项目加载失败: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                });
                
                input.click();
            }
            
            showNotification(message, type = 'info') {
                this.notification.textContent = message;
                this.notification.className = 'notification show';
                
                setTimeout(() => {
                    this.notification.className = 'notification';
                }, 3000);
            }
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            new RankineCycleApp();
        });
    </script>
</body>
</html>